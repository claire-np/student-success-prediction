# SCRIPT 06: GBM MODELING

# Load packages
source("scripts/00_load_packages.R")

# Load training/testing data
df_train <- readRDS("data_processed/df_train.rds")
df_test  <- readRDS("data_processed/df_test.rds")

set.seed(2025)

# GBM model
gbm_model <- caret::train(
  final_grade ~ .,
  data = df_train,
  method = "gbm",
  trControl = caret::trainControl(
    method = "repeatedcv",
    number = 10,
    repeats = 5,
    verboseIter = FALSE
  ),
  verbose = FALSE
)

# Predictions
df_test$pred_gbm <- predict(gbm_model, df_test)

# Metrics
gbm_metrics <- caret::defaultSummary(
  data.frame(
    obs  = df_test$final_grade,
    pred = df_test$pred_gbm
  )
)

# Output directories
dir.create("results/models", recursive = TRUE, showWarnings = FALSE)
dir.create("results/tables", recursive = TRUE, showWarnings = FALSE)

# Save artifacts
saveRDS(gbm_model,   "results/models/gbm_model.rds")
saveRDS(gbm_metrics, "results/tables/gbm_metrics.rds")
